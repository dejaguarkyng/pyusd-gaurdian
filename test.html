<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PYUSD Guardian</title>
  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Socket.IO Client -->
  <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
  
  <!-- Prevent reload loop detection script -->
  <script>
    // Prevent reload loops by adding a counter to localStorage
    try {
      const reloadCount = parseInt(localStorage.getItem('reloadCount') || '0');
      console.log('Page load count:', reloadCount + 1);
      
      if (reloadCount > 5) {
        console.error('Detected reload loop, stopping initialization');
        localStorage.setItem('reloadCount', '0');
        // Prevent further initialization
        window.stopInitialization = true;
        alert('Reload loop detected. The page has been reset.');
      } else {
        localStorage.setItem('reloadCount', (reloadCount + 1).toString());
        // Reset count after 10 seconds if page stays loaded
        setTimeout(() => localStorage.setItem('reloadCount', '0'), 10000);
      }
    } catch (e) {
      console.error('Error in reload detection:', e);
    }
  </script>
  
  <!-- Prevent theme flashing -->
  <script>
    // Immediately set theme before page renders to prevent flashing
    (function() {
      try {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'light') {
          document.documentElement.classList.remove('dark');
        } else {
          document.documentElement.classList.add('dark');
        }
      } catch (e) {
        // If localStorage fails, default to dark theme
        document.documentElement.classList.add('dark');
      }
    })();
  </script>
  
  <!-- Tailwind Configuration -->
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        fontFamily: {
          'sans': ['Inter', 'sans-serif'],
          'serif': ['Playfair Display', 'serif'],
        },
        extend: {
          colors: {
            gold: {
              50: '#FFF9E5',
              100: '#FFF0BF',
              200: '#FFE380',
              300: '#FFD740',
              400: '#FFC700',
              500: '#F2B200',
              600: '#D69E00',
              700: '#B38600',
              800: '#8F6B00',
              900: '#6B5000',
            },
            dark: {
              800: '#1E1E1E',
              900: '#121212',
            }
          },
          boxShadow: {
            'gold': '0 4px 14px 0 rgba(242, 178, 0, 0.1)',
          }
        }
      }
    }
  </script>
  
  <!-- Custom Styles -->
  <style type="text/tailwind">
    @layer components {
      .gold-gradient {
        @apply bg-gradient-to-r from-gold-400 to-gold-600;
      }
      .gold-text {
        @apply text-transparent bg-clip-text gold-gradient;
      }
      .gold-border {
        @apply border-gold-400;
      }
      .card {
        @apply dark:bg-dark-800 bg-white rounded-xl border dark:border-gold-800/30 border-gold-300/50 shadow-lg overflow-hidden transition-all duration-200;
      }
      .card-header {
        @apply px-6 py-4 border-b dark:border-gold-800/30 border-gold-300/50 dark:bg-dark-900/50 bg-gold-50;
      }
      .btn-gold {
        @apply gold-gradient dark:text-dark-900 text-white font-medium px-4 py-2 rounded-lg hover:shadow-gold transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-gold-300 dark:focus:ring-gold-700;
      }
      .btn-dark {
        @apply dark:bg-dark-900 bg-white text-gold-600 border dark:border-gold-700/30 border-gold-300 px-4 py-2 rounded-lg hover:border-gold-400 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-gold-300 dark:focus:ring-gold-700;
      }
      .theme-toggle {
        @apply w-10 h-10 rounded-full flex items-center justify-center cursor-pointer transition-all duration-200 hover:bg-gold-200/20;
      }
      .loading-spinner {
        @apply inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-current border-r-transparent align-[-0.125em] motion-reduce:animate-[spin_1.5s_linear_infinite];
      }
      .table-header {
        @apply px-6 py-4 text-left text-xs font-medium dark:text-gold-300 text-gold-700 uppercase tracking-wider;
      }
      .table-cell {
        @apply px-6 py-4;
      }
      .status-badge {
        @apply px-2 py-1 text-xs rounded-full;
      }
      .status-flagged {
        @apply dark:bg-red-500/20 bg-red-100 text-red-500 border dark:border-red-500/30 border-red-200;
      }
      .status-compliant {
        @apply dark:bg-green-500/20 bg-green-100 text-green-600 border dark:border-green-500/30 border-green-200;
      }
      .alert-item {
        @apply border-b dark:border-gold-800/30 border-gold-300/50 p-4 dark:hover:bg-dark-900/30 hover:bg-gold-50 transition-colors duration-200;
      }
      .code-block {
        @apply dark:bg-dark-900 bg-gold-50 p-3 rounded-md border dark:border-gold-800/30 border-gold-300/50 font-mono text-sm;
      }
      .tab {
        @apply px-4 py-2 font-medium cursor-pointer border-b-2 transition-colors duration-200;
      }
      .tab-active {
        @apply border-gold-500 dark:text-gold-400 text-gold-600;
      }
      .tab-inactive {
        @apply border-transparent dark:text-gray-400 text-gray-500 hover:dark:text-gold-300 hover:text-gold-500;
      }
    }
  </style>
</head>
<body class="dark:bg-dark-900 bg-gray-50 dark:text-white text-gray-800 font-sans">
  <div class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="dark:border-b dark:border-gold-800/30 border-b border-gold-300/50 py-4 dark:bg-dark-800 bg-white sticky top-0 z-10 shadow-sm">
      <div class="container mx-auto px-4 md:px-6 flex justify-between items-center">
        <div class="flex items-center space-x-3">
          <div class="gold-gradient w-10 h-10 rounded-full flex items-center justify-center shadow-lg">
            <i class="fas fa-shield-alt dark:text-dark-900 text-white text-lg"></i>
          </div>
          <h1 class="font-serif text-2xl font-bold gold-text">PYUSD Guardian</h1>
        </div>
        <div class="flex items-center space-x-4">
          <div id="connection-status" class="hidden md:flex items-center space-x-2">
            <span class="h-2 w-2 bg-yellow-500 rounded-full"></span>
            <span class="text-sm dark:text-gold-200 text-gold-700">Connecting...</span>
          </div>
          <div id="theme-toggle" class="theme-toggle dark:bg-gold-400/10 bg-gold-100 dark:text-gold-300 text-gold-600">
            <i id="theme-icon" class="fas fa-sun"></i>
          </div>
          <button id="refresh-btn" class="btn-gold">
            <i class="fas fa-sync-alt mr-2"></i><span class="hidden sm:inline">Refresh</span>
          </button>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 container mx-auto px-4 md:px-6 py-6">
      <!-- Stats -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="card p-4 hover:shadow-gold transition-shadow duration-300">
          <p class="text-sm dark:text-gold-300 text-gold-700 mb-1">Current Block</p>
          <p id="current-block" class="text-xl font-bold gold-text">-</p>
        </div>
        <div class="card p-4 hover:shadow-gold transition-shadow duration-300">
          <p class="text-sm dark:text-gold-300 text-gold-700 mb-1">Transactions</p>
          <p id="pyusd-tx-count" class="text-xl font-bold gold-text">-</p>
        </div>
        <div class="card p-4 hover:shadow-gold transition-shadow duration-300">
          <p class="text-sm dark:text-gold-300 text-gold-700 mb-1">Flagged</p>
          <p id="flagged-tx-count" class="text-xl font-bold text-red-500">-</p>
        </div>
        <div class="card p-4 hover:shadow-gold transition-shadow duration-300">
          <p class="text-sm dark:text-gold-300 text-gold-700 mb-1">Monitoring Since</p>
          <p id="monitoring-since" class="text-xl font-bold gold-text">-</p>
        </div>
      </div>

      <!-- Tabs -->
      <div class="card mb-6">
        <div class="border-b dark:border-gold-800/30 border-gold-300/50">
          <div class="flex overflow-x-auto">
            <div id="tab-transactions" class="tab tab-active">Transactions</div>
            <div id="tab-alerts" class="tab tab-inactive">Alerts</div>
            <div id="tab-analytics" class="tab tab-inactive">Analytics</div>
          </div>
        </div>
        
        <!-- Tab Content -->
        <div id="tab-content" class="p-4">
          <!-- Transaction Tab (Default) -->
          <div id="content-transactions" class="space-y-4">
            <div class="flex justify-between items-center mb-4">
              <h2 class="font-serif text-xl gold-text">Recent Transactions</h2>
              <select id="tx-filter" class="dark:bg-dark-900 bg-white dark:text-gold-200 text-gold-700 text-sm rounded-md px-3 py-2 border dark:border-gold-700/30 border-gold-300 focus:border-gold-400 focus:outline-none focus:ring-2 focus:ring-gold-300/50">
                <option value="all">All Transactions</option>
                <option value="flagged">Flagged Only</option>
              </select>
            </div>
            
            <div class="overflow-x-auto rounded-lg border dark:border-gold-800/30 border-gold-300/50">
              <table class="min-w-full divide-y dark:divide-gold-800/30 divide-gold-300/50">
                <thead class="dark:bg-dark-900/50 bg-gold-50/50">
                  <tr>
                    <th scope="col" class="table-header">Transaction Hash</th>
                    <th scope="col" class="table-header">Block</th>
                    <th scope="col" class="table-header">Status</th>
                    <th scope="col" class="table-header text-right">Actions</th>
                  </tr>
                </thead>
                <tbody id="tx-table-body" class="divide-y dark:divide-gold-800/30 divide-gold-300/50 dark:bg-dark-800/50 bg-white">
                  <!-- Transactions will be inserted here -->
                  <tr>
                    <td colspan="4" class="px-6 py-10 text-center dark:text-gold-200/50 text-gold-700/50">
                      <div class="flex flex-col items-center justify-center">
                        <i class="fas fa-circle-notch fa-spin mb-3 text-2xl dark:text-gold-400/30 text-gold-400/70"></i>
                        <p>Loading transactions...</p>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          
          <!-- Alerts Tab (Hidden by default) -->
          <div id="content-alerts" class="hidden space-y-4">
            <div class="flex justify-between items-center mb-4">
              <h2 class="font-serif text-xl gold-text">Recent Alerts</h2>
              <select id="alert-filter" class="dark:bg-dark-900 bg-white dark:text-gold-200 text-gold-700 text-sm rounded-md px-3 py-2 border dark:border-gold-700/30 border-gold-300 focus:border-gold-400 focus:outline-none focus:ring-2 focus:ring-gold-300/50">
                <option value="all">All Severities</option>
                <option value="high">High Risk Only</option>
                <option value="medium">Medium Risk Only</option>
                <option value="low">Low Risk Only</option>
              </select>
            </div>
            
            <div id="alerts-container" class="space-y-3 max-h-[600px] overflow-y-auto pr-1">
              <!-- Alerts will be inserted here -->
              <div class="px-6 py-10 text-center dark:text-gold-200/50 text-gold-700/50">
                <div class="flex flex-col items-center justify-center">
                  <i class="fas fa-circle-notch fa-spin mb-3 text-2xl dark:text-gold-400/30 text-gold-400/70"></i>
                  <p>Loading alerts...</p>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Analytics Tab (Hidden by default) -->
          <div id="content-analytics" class="hidden space-y-4">
            <div class="flex justify-between items-center mb-4">
              <h2 class="font-serif text-xl gold-text">Transaction Analytics</h2>
              <select id="analytics-timeframe" class="dark:bg-dark-900 bg-white dark:text-gold-200 text-gold-700 text-sm rounded-md px-3 py-2 border dark:border-gold-700/30 border-gold-300 focus:border-gold-400 focus:outline-none focus:ring-2 focus:ring-gold-300/50">
                <option value="day">Last 24 Hours</option>
                <option value="week">Last 7 Days</option>
                <option value="month">Last 30 Days</option>
              </select>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="card p-4">
                <h3 class="text-lg font-medium mb-4 dark:text-gold-300 text-gold-700">Transaction Volume</h3>
                <div class="h-64 flex items-center justify-center">
                  <p class="text-sm dark:text-gold-200/50 text-gold-700/50">Analytics visualization will appear here</p>
                </div>
              </div>
              
              <div class="card p-4">
                <h3 class="text-lg font-medium mb-4 dark:text-gold-300 text-gold-700">Risk Distribution</h3>
                <div class="h-64 flex items-center justify-center">
                  <p class="text-sm dark:text-gold-200/50 text-gold-700/50">Analytics visualization will appear here</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
    
    <!-- Footer -->
    <footer class="dark:bg-dark-800 bg-white border-t dark:border-gold-800/30 border-gold-300/50 py-4">
      <div class="container mx-auto px-4 md:px-6 flex flex-col md:flex-row justify-between items-center">
        <div class="text-sm dark:text-gold-200/70 text-gold-700/70 mb-2 md:mb-0">
          © 2025 PYUSD Guardian. All rights reserved.
        </div>
        <div class="flex items-center space-x-4">
          <a href="#" class="text-sm dark:text-gold-300 text-gold-600 hover:text-gold-500 transition-colors">Documentation</a>
          <a href="#" class="text-sm dark:text-gold-300 text-gold-600 hover:text-gold-500 transition-colors">API</a>
          <a href="#" class="text-sm dark:text-gold-300 text-gold-600 hover:text-gold-500 transition-colors">Support</a>
        </div>
      </div>
    </footer>
  </div>

  <!-- Transaction Details Modal -->
  <div id="tx-modal" class="fixed inset-0 dark:bg-black/80 bg-black/50 backdrop-blur-sm flex items-center justify-center hidden z-50">
    <div class="dark:bg-dark-800 bg-white rounded-lg border dark:border-gold-700/50 border-gold-300/50 max-w-3xl w-full mx-4 max-h-[80vh] overflow-y-auto shadow-xl">
      <div class="flex justify-between items-center px-6 py-4 border-b dark:border-gold-800/30 border-gold-300/50">
        <h3 class="font-serif text-xl gold-text">Transaction Details</h3>
        <button id="close-modal" class="dark:text-gold-300 text-gold-600 hover:text-gold-400 p-2 rounded-full hover:bg-gold-100/20 transition-colors">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="p-6">
        <div id="tx-details-content">
          <!-- Transaction details will be inserted here -->
          <div class="flex justify-center items-center py-10">
            <i class="fas fa-circle-notch fa-spin text-2xl dark:text-gold-400 text-gold-600 mr-3"></i>
            <p>Loading transaction details...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Modal -->
  <div id="loading-modal" class="fixed inset-0 dark:bg-black/80 bg-black/50 backdrop-blur-sm flex items-center justify-center hidden z-50">
    <div class="dark:bg-dark-800 bg-white rounded-lg border dark:border-gold-700/50 border-gold-300/50 p-8 max-w-md w-full mx-4 text-center shadow-xl">
      <div class="gold-gradient w-16 h-16 rounded-full mx-auto mb-4 flex items-center justify-center">
        <div class="loading-spinner dark:text-dark-900 text-white"></div>
      </div>
      <h3 class="font-serif text-xl gold-text mb-2" id="loading-title">Loading Data</h3>
      <p class="dark:text-gold-200 text-gold-700" id="loading-message">Please wait while we fetch the latest information...</p>
    </div>
  </div>

  <!-- Error Toast -->
  <div id="error-toast" class="fixed bottom-4 right-4 bg-red-500 text-white px-4 py-3 rounded-lg shadow-lg hidden transform transition-transform duration-300 ease-in-out">
    <div class="flex items-center">
      <i class="fas fa-exclamation-circle mr-2"></i>
      <span id="error-message">An error occurred</span>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    // API Configuration
    const API_BASE_URL = 'http://localhost:3000/api'; // Change to your actual API URL
    const WS_URL = 'http://localhost:3000'; // Change to your actual WebSocket URL
    
    // PYUSD Contract Address
    const PYUSD_ADDRESS = '0x6c3ea9036406852006290770b2e17e0e4f37f978';
    
    // App State
    const appState = {
      currentBlock: 0,
      startTime: null,
      transactions: [],
      alerts: [],
      socket: null,
      connected: false,
      reconnectAttempts: 0,
      maxReconnectAttempts: 5,
      reconnectDelay: 3000,
      reconnectTimer: null,
      isUpdating: false, // Flag to prevent concurrent UI updates
      activeTab: 'transactions'
    };

    // Global flags to prevent initialization issues
    window.socketInitialized = false;
    window.uiInitialized = false;

    // DOM Elements
    const connectionStatus = document.getElementById('connection-status');
    const currentBlockEl = document.getElementById('current-block');
    const pyusdTxCountEl = document.getElementById('pyusd-tx-count');
    const flaggedTxCountEl = document.getElementById('flagged-tx-count');
    const monitoringSinceEl = document.getElementById('monitoring-since');
    const txTableBody = document.getElementById('tx-table-body');
    const alertsContainer = document.getElementById('alerts-container');
    const txFilter = document.getElementById('tx-filter');
    const alertFilter = document.getElementById('alert-filter');
    const refreshBtn = document.getElementById('refresh-btn');
    const txModal = document.getElementById('tx-modal');
    const closeModal = document.getElementById('close-modal');
    const txDetailsContent = document.getElementById('tx-details-content');
    const errorToast = document.getElementById('error-toast');
    const errorMessage = document.getElementById('error-message');
    const loadingModal = document.getElementById('loading-modal');
    const loadingTitle = document.getElementById('loading-title');
    const loadingMessage = document.getElementById('loading-message');
    
    // Tab elements
    const tabTransactions = document.getElementById('tab-transactions');
    const tabAlerts = document.getElementById('tab-alerts');
    const tabAnalytics = document.getElementById('tab-analytics');
    const contentTransactions = document.getElementById('content-transactions');
    const contentAlerts = document.getElementById('content-alerts');
    const contentAnalytics = document.getElementById('content-analytics');

    // Theme toggle functionality - FIXED VERSION
    function initializeTheme() {
      try {
        const htmlElement = document.documentElement;
        const themeToggle = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');
        const savedTheme = localStorage.getItem('theme');
        
        if (savedTheme === 'light') {
          htmlElement.classList.remove('dark');
          themeIcon.classList.remove('fa-sun');
          themeIcon.classList.add('fa-moon');
        } else {
          htmlElement.classList.add('dark');
          themeIcon.classList.remove('fa-moon');
          themeIcon.classList.add('fa-sun');
          
          // Only set if not already set
          if (!savedTheme) {
            localStorage.setItem('theme', 'dark');
          }
        }
        
        // Toggle theme function - debounced to prevent rapid toggling
        let themeToggleTimeout;
        themeToggle.addEventListener('click', function() {
          // Prevent multiple rapid clicks
          if (themeToggleTimeout) {
            return;
          }
          
          themeToggleTimeout = setTimeout(() => {
            themeToggleTimeout = null;
          }, 300); // 300ms debounce
          
          if (htmlElement.classList.contains('dark')) {
            htmlElement.classList.remove('dark');
            localStorage.setItem('theme', 'light');
            themeIcon.classList.remove('fa-sun');
            themeIcon.classList.add('fa-moon');
          } else {
            htmlElement.classList.add('dark');
            localStorage.setItem('theme', 'dark');
            themeIcon.classList.remove('fa-moon');
            themeIcon.classList.add('fa-sun');
          }
        });
      } catch (e) {
        console.error('Theme initialization error:', e);
        // Continue without crashing
      }
    }

    // Show loading modal
    function showLoading(title = 'Loading Data', message = 'Please wait while we fetch the latest information...') {
      loadingTitle.textContent = title;
      loadingMessage.textContent = message;
      loadingModal.classList.remove('hidden');
    }

    // Hide loading modal
    function hideLoading() {
      loadingModal.classList.add('hidden');
    }

    // Helper function to show error toast
    function showError(message) {
      errorMessage.textContent = message;
      errorToast.classList.remove('hidden');
      errorToast.classList.add('translate-y-0');
      
      setTimeout(() => {
        errorToast.classList.add('translate-y-full');
        setTimeout(() => {
          errorToast.classList.add('hidden');
          errorToast.classList.remove('translate-y-full');
        }, 300);
      }, 5000);
    }

    // Helper function for API calls with error handling
    async function fetchAPI(endpoint, options = {}, showLoadingIndicator = false) {
      if (showLoadingIndicator) {
        showLoading('Loading Data', 'Fetching data from the server...');
      }
      
      try {
        const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || `API error: ${response.status}`);
        }
        return await response.json();
      } catch (error) {
        showError(`Failed to fetch data: ${error.message}`);
        throw error;
      } finally {
        if (showLoadingIndicator) {
          hideLoading();
        }
      }
    }

    // Initialize WebSocket with safeguards against reload loops
    function initializeWebSocket() {
      // Prevent multiple initializations in the same page load
      if (window.socketInitialized) {
        console.log("Socket already initialized, skipping");
        return;
      }
      
      window.socketInitialized = true;
      console.log("Socket initialization started");
      
      // Clean up any existing socket connection
      if (appState.socket) {
        try {
          appState.socket.disconnect();
          appState.socket.removeAllListeners();
        } catch (e) {
          console.error('Error cleaning up socket:', e);
        }
        appState.socket = null;
      }
      
      // Clear any pending reconnect timers
      if (appState.reconnectTimer) {
        clearTimeout(appState.reconnectTimer);
        appState.reconnectTimer = null;
      }
      
      try {
        updateConnectionStatus('connecting');
        console.log('Initializing WebSocket connection...');
        
        appState.socket = io(WS_URL, {
          reconnection: false, // We'll handle reconnection manually
          timeout: 10000,
          transports: ['websocket']
        });
        
        appState.socket.on('connect', () => {
          logPersistent("WebSocket connected");

          appState.connected = true;
          appState.reconnectAttempts = 0;
          updateConnectionStatus('connected');
        });
        
        appState.socket.on('disconnect', (reason) => {
          logPersistent("WebSocket disconnected: " + reason);
          appState.connected = false;
          updateConnectionStatus('disconnected');
          
          // Only attempt to reconnect if not closing intentionally
          if (reason !== 'io client disconnect') {
            scheduleReconnect();
          }
        });
        
        appState.socket.on('connect_error', (error) => {
          logPersistent("WebSocket connection error: " + error, 'error');
          appState.connected = false;
          updateConnectionStatus('error');
          scheduleReconnect();
        });
        
        // Throttle the new-alert handler to prevent UI flickering
        let alertDebounceTimer = null;
        let pendingAlerts = [];
        
        appState.socket.on('new-alert', (alert) => {
          console.log('New alert received:', alert);
          
          // Add to pending alerts
          pendingAlerts.push(alert);
          
          // If we already have a timer running, let it handle the update
          if (alertDebounceTimer) return;
          
          // Set a timer to process alerts in batches
          alertDebounceTimer = setTimeout(() => {
            processAlertBatch(pendingAlerts);
            pendingAlerts = [];
            alertDebounceTimer = null;
          }, 500); // Process alerts at most every 500ms
        });
      } catch (error) {
        console.error('Failed to initialize WebSocket:', error);
        updateConnectionStatus('error');
        scheduleReconnect();
      }
    }


    function logPersistent(message, level = 'log') {
      const timestamp = new Date().toISOString();
      const fullMessage = `[${timestamp}] ${message}`;
    
      // Save to localStorage (with a capped size)
      const logs = JSON.parse(localStorage.getItem('persistentLogs') || '[]');
      logs.push(fullMessage);
      if (logs.length > 1000) logs.shift(); // keep last 1000 entries
      localStorage.setItem('persistentLogs', JSON.stringify(logs));
    
      // Also log to console
      console[level](fullMessage);
    }
    
    // Clear logs manually when needed
    window.clearPersistentLogs = () => localStorage.removeItem('persistentLogs');
    window.showPersistentLogs = () => console.log(JSON.parse(localStorage.getItem('persistentLogs')));

    
    function processAlertBatch(alerts) {
      if (appState.isUpdating || alerts.length === 0) return;
      
      appState.isUpdating = true;
      
      try {
        // Add all alerts to the state
        alerts.forEach(alert => {
          // Add to alerts
          appState.alerts.unshift(alert);
          
          // Create transaction object from alert
          const tx = {
            hash: alert.txHash,
            blockNumber: alert.blockNumber,
            flagged: true,
            timestamp: new Date(alert.timestamp),
            complianceFlags: [{
              rule: alert.rule,
              details: alert.details,
              severity: getSeverityFromRule(alert.rule)
            }]
          };
          
          // Add to transactions if not already present
          if (!appState.transactions.some(t => t.hash === tx.hash)) {
            appState.transactions.unshift(tx);
          }
        });
        
        // Keep only the last 50 alerts
        if (appState.alerts.length > 50) {
          appState.alerts = appState.alerts.slice(0, 50);
        }
        
        // Keep only the last 100 transactions
        if (appState.transactions.length > 100) {
          appState.transactions = appState.transactions.slice(0, 100);
        }
        
        // Update UI once for all alerts
        updateStats();
        renderTransactions();
        renderAlerts();
      } catch (error) {
        console.error('Error processing alerts:', error);
      } finally {
        appState.isUpdating = false;
      }
    }

    function scheduleReconnect() {
      if (appState.reconnectTimer) return;
      
      // Add exponential backoff with a longer initial delay
      const delay = 2000 + appState.reconnectDelay * Math.pow(1.5, appState.reconnectAttempts);
      console.log(`Scheduling reconnect attempt ${appState.reconnectAttempts + 1} in ${delay}ms`);
      
      appState.reconnectTimer = setTimeout(() => {
        appState.reconnectAttempts++;
        appState.reconnectTimer = null;
        console.log(`Reconnect attempt ${appState.reconnectAttempts}`);
        
        // Only try to reconnect if we haven't exceeded the maximum attempts
        if (appState.reconnectAttempts < appState.maxReconnectAttempts) {
          initializeWebSocket();
        } else {
          console.error('Maximum reconnection attempts reached');
          updateConnectionStatus('error');
        }
      }, delay);
    }

    // Update connection status indicator
    function updateConnectionStatus(status) {
      const statusDot = connectionStatus.querySelector('span:first-child');
      const statusText = connectionStatus.querySelector('span:last-child');
      
      switch (status) {
        case 'connected':
          statusDot.className = 'h-2 w-2 bg-green-500 rounded-full';
          statusText.textContent = 'Monitoring';
          break;
        case 'disconnected':
          statusDot.className = 'h-2 w-2 bg-red-500 rounded-full';
          statusText.textContent = 'Disconnected';
          break;
        case 'connecting':
          statusDot.className = 'h-2 w-2 bg-yellow-500 rounded-full';
          statusText.textContent = 'Connecting...';
          break;
        case 'error':
          statusDot.className = 'h-2 w-2 bg-red-500 rounded-full';
          statusText.textContent = 'Connection Error';
          break;
        default:
          statusDot.className = 'h-2 w-2 bg-gray-500 rounded-full';
          statusText.textContent = 'Unknown';
      }
    }

    // Initialize UI with safeguards against reload loops
    function initializeUI() {
      // Check if we should stop initialization due to reload loop
      if (window.stopInitialization) {
        console.log('Initialization stopped to prevent reload loop');
        return;
      }
      
      // Set a flag to prevent multiple initializations
      if (window.uiInitialized) {
        console.log('UI already initialized, skipping');
        return;
      }
      window.uiInitialized = true;
      
      console.log('UI initialization started');
      
      // Initialize theme first to prevent flashing
      initializeTheme();
      
      updateConnectionStatus('connecting');
      showLoading('Initializing', 'Setting up PYUSD Guardian...');
      
      // Use a timeout to fetch data after a short delay
      setTimeout(async () => {
        try {
          // Fetch initial status
          const status = await fetchAPI('/status');
          appState.currentBlock = status.currentBlock;
          appState.startTime = new Date(Date.now() - (status.uptime * 1000));
          
          // Fetch alerts
          const alerts = await fetchAPI('/alerts');
          appState.alerts = alerts.data || [];
          
          // Create transactions from alerts
          appState.transactions = appState.alerts.map(alert => ({
            hash: alert.txHash,
            blockNumber: alert.blockNumber,
            flagged: true,
            timestamp: new Date(alert.timestamp),
            complianceFlags: [{
              rule: alert.rule,
              details: alert.details,
              severity: getSeverityFromRule(alert.rule)
            }]
          }));
          
          // Update UI
          updateStats();
          renderTransactions();
          renderAlerts();
          
          // Initialize WebSocket
          initializeWebSocket();
          
          // Set up event listeners
          setupEventListeners();
        } catch (error) {
          console.error('Failed to initialize UI:', error);
          updateConnectionStatus('error');
          
          // Show empty states
          txTableBody.innerHTML = `
            <tr>
              <td colspan="4" class="px-6 py-10 text-center dark:text-gold-200/50 text-gold-700/50">
                <div class="flex flex-col items-center justify-center">
                  <i class="fas fa-exclamation-circle mb-3 text-2xl text-red-500"></i>
                  <p>Failed to load transactions</p>
                </div>
              </td>
            </tr>
          `;
          
          alertsContainer.innerHTML = `
            <div class="px-6 py-10 text-center dark:text-gold-200/50 text-gold-700/50">
              <div class="flex flex-col items-center justify-center">
                <i class="fas fa-exclamation-circle mb-3 text-2xl text-red-500"></i>
                <p>Failed to load alerts</p>
              </div>
            </div>
          `;
        } finally {
          hideLoading();
        }
      }, 500); // Short delay to ensure DOM is ready
    }

    // Update dashboard statistics
    function updateStats() {
      currentBlockEl.textContent = appState.currentBlock.toLocaleString();
      pyusdTxCountEl.textContent = appState.transactions.length;
      flaggedTxCountEl.textContent = appState.transactions.filter(tx => tx.flagged).length;
      
      if (appState.startTime) {
        monitoringSinceEl.textContent = formatDate(appState.startTime).split(',')[0];
      } else {
        monitoringSinceEl.textContent = '-';
      }
    }

    // Render transaction table
    function renderTransactions() {
      // Filter transactions if needed
      const filteredTxs = txFilter.value === 'flagged' 
        ? appState.transactions.filter(tx => tx.flagged)
        : appState.transactions;
      
      if (filteredTxs.length === 0) {
        txTableBody.innerHTML = `
          <tr>
            <td colspan="4" class="px-6 py-10 text-center dark:text-gold-200/50 text-gold-700/50">
              <div class="flex flex-col items-center justify-center">
                <i class="fas fa-search mb-3 text-2xl dark:text-gold-400/30 text-gold-400/70"></i>
                <p>No transactions to display</p>
              </div>
            </td>
          </tr>
        `;
        return;
      }

      // Sort by block number (descending)
      const sortedTxs = [...filteredTxs].sort((a, b) => b.blockNumber - a.blockNumber);
      
      // Generate table rows
      txTableBody.innerHTML = sortedTxs.map(tx => `
        <tr class="${tx.flagged ? 'dark:bg-red-900/10 bg-red-50' : ''} hover:dark:bg-dark-900/20 hover:bg-gold-50/50 transition-colors duration-200">
          <td class="table-cell">
            <div class="font-mono text-sm truncate max-w-[150px] dark:text-gold-100 text-gray-800" title="${tx.hash}">
              ${tx.hash.substring(0, 10)}...
            </div>
          </td>
          <td class="table-cell">
            <div class="text-sm dark:text-gold-100 text-gray-800">${tx.blockNumber.toLocaleString()}</div>
          </td>
          <td class="table-cell">
            <span class="status-badge ${tx.flagged ? 'status-flagged' : 'status-compliant'}">
              ${tx.flagged ? 'Flagged' : 'Compliant'}
            </span>
          </td>
          <td class="table-cell text-right">
            <button class="dark:text-gold-400 text-gold-600 hover:text-gold-500 text-sm view-tx px-3 py-1 rounded-md hover:bg-gold-100/20 transition-colors" data-hash="${tx.hash}">
              View Details
            </button>
          </td>
        </tr>
      `).join('');

      // Add event listeners to view buttons
      document.querySelectorAll('.view-tx').forEach(btn => {
        btn.addEventListener('click', () => {
          const hash = btn.getAttribute('data-hash');
          showTransactionDetails(hash);
        });
      });
    }

    // Render alerts
    function renderAlerts() {
      if (appState.alerts.length === 0) {
        alertsContainer.innerHTML = `
          <div class="px-6 py-10 text-center dark:text-gold-200/50 text-gold-700/50">
            <div class="flex flex-col items-center justify-center">
              <i class="fas fa-bell-slash mb-3 text-2xl dark:text-gold-400/30 text-gold-400/70"></i>
              <p>No alerts to display</p>
            </div>
          </div>
        `;
        return;
      }

      // Filter alerts if needed
      let filteredAlerts = [...appState.alerts];
      if (alertFilter.value !== 'all') {
        filteredAlerts = filteredAlerts.filter(alert => 
          getSeverityFromRule(alert.rule).toLowerCase() === alertFilter.value
        );
      }
      
      if (filteredAlerts.length === 0) {
        alertsContainer.innerHTML = `
          <div class="px-6 py-10 text-center dark:text-gold-200/50 text-gold-700/50">
            <div class="flex flex-col items-center justify-center">
              <i class="fas fa-filter mb-3 text-2xl dark:text-gold-400/30 text-gold-400/70"></i>
              <p>No alerts match the selected filter</p>
            </div>
          </div>
        `;
        return;
      }

      // Sort alerts by timestamp (newest first)
      const sortedAlerts = filteredAlerts.sort((a, b) => 
        new Date(b.timestamp) - new Date(a.timestamp)
      );
      
      alertsContainer.innerHTML = sortedAlerts.map(alert => {
        const severity = getSeverityFromRule(alert.rule);
        return `
          <div class="card alert-item">
            <div class="flex justify-between items-start">
              <div class="flex items-start space-x-3">
                <div class="mt-1">
                  <i class="fas fa-exclamation-triangle ${getSeverityColor(severity)}"></i>
                </div>
                <div>
                  <h3 class="font-medium dark:text-gold-100 text-gray-800">${alert.rule}</h3>
                  <p class="text-sm dark:text-gold-200/70 text-gray-600 mt-1">${
                    typeof alert.details === 'string' 
                      ? alert.details 
                      : JSON.stringify(alert.details).substring(0, 100) + '...'
                  }</p>
                </div>
              </div>
              <span class="text-xs dark:text-gold-300/50 text-gold-700/70">${formatTime(new Date(alert.timestamp))}</span>
            </div>
            <div class="mt-3 flex items-center justify-between">
              <span class="status-badge ${getSeverityBgColor(severity)}">
                ${severity} Risk
              </span>
              <button class="dark:text-gold-400 text-gold-600 hover:text-gold-500 text-xs view-tx px-2 py-1 rounded-md hover:bg-gold-100/20 transition-colors" data-hash="${alert.txHash}">
                View Transaction
              </button>
            </div>
          </div>
        `;
      }).join('');

      // Add event listeners to view buttons in alerts
      alertsContainer.querySelectorAll('.view-tx').forEach(btn => {
        btn.addEventListener('click', () => {
          const hash = btn.getAttribute('data-hash');
          showTransactionDetails(hash);
        });
      });
    }

    // Show transaction details in modal
    async function showTransactionDetails(hash) {
      txModal.classList.remove('hidden');
      txDetailsContent.innerHTML = `
        <div class="flex justify-center items-center py-10">
          <i class="fas fa-circle-notch fa-spin text-2xl dark:text-gold-400 text-gold-600 mr-3"></i>
          <p>Loading transaction details...</p>
        </div>
      `;
      
      showLoading('Loading Transaction', 'Fetching transaction details...');
      
      try {
        // Find transaction in local state first
        let tx = appState.transactions.find(t => t.hash === hash);
        
        // If not found or we need more details, fetch from API
        if (!tx || !tx.details) {
          const alertData = await fetchAPI(`/alerts/${hash}`);
          
          // Create or update transaction object
          tx = {
            hash: alertData.txHash,
            blockNumber: alertData.blockNumber,
            flagged: true,
            timestamp: new Date(alertData.timestamp),
            from: alertData.riskReport?.from || 'Unknown',
            to: alertData.riskReport?.to || 'Unknown',
            method: alertData.riskReport?.method || 'Unknown',
            value: alertData.riskReport?.value || 0,
            gasUsed: alertData.riskReport?.gasUsed || 0,
            complianceFlags: [{
              rule: alertData.rule,
              details: alertData.details,
              severity: getSeverityFromRule(alertData.rule)
            }],
            riskReport: alertData.riskReport
          };
          
          // Update in our local state
          const existingIndex = appState.transactions.findIndex(t => t.hash === hash);
          if (existingIndex >= 0) {
            appState.transactions[existingIndex] = tx;
          }
        }
        
        // Create a trace example from the risk report if available
        const trace = tx.riskReport?.trace || {
          calls: [
            {
              type: "CALL",
              from: tx.from || "0x0000000000000000000000000000000000000000",
              to: tx.to || "0x0000000000000000000000000000000000000000",
              value: "0x0",
              gas: "0x" + Math.floor(Math.random() * 100000).toString(16),
              input: "0xa9059cbb000000000000000000000000d8da6bf26964af9d7eed9e03e53415d37aa96045000000000000000000000000000000000000000000000000000000003b9aca00"
            }
          ]
        };

        txDetailsContent.innerHTML = `
          <div class="space-y-6">
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-3">
                <span class="status-badge ${tx.flagged ? 'status-flagged' : 'status-compliant'}">
                  ${tx.flagged ? 'Flagged' : 'Compliant'}
                </span>
                <span class="text-sm dark:text-gold-300 text-gold-700">Block #${tx.blockNumber.toLocaleString()}</span>
              </div>
              <a href="https://etherscan.io/tx/${tx.hash}" target="_blank" class="dark:text-gold-400 text-gold-600 hover:text-gold-500 text-sm flex items-center px-3 py-1 rounded-md hover:bg-gold-100/20 transition-colors">
                View on Etherscan
                <i class="fas fa-external-link-alt ml-1"></i>
              </a>
            </div>

            <div>
              <h4 class="text-sm dark:text-gold-300 text-gold-700 mb-2">Transaction Hash</h4>
              <div class="code-block">
                <p class="break-all dark:text-gold-100 text-gray-800">${tx.hash}</p>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <h4 class="text-sm dark:text-gold-300 text-gold-700 mb-2">From</h4>
                <div class="code-block">
                  <p class="break-all dark:text-gold-100 text-gray-800">${tx.from || 'Unknown'}</p>
                </div>
              </div>
              <div>
                <h4 class="text-sm dark:text-gold-300 text-gold-700 mb-2">To</h4>
                <div class="code-block">
                  <p class="break-all dark:text-gold-100 text-gray-800">${tx.to || 'Unknown'}</p>
                  ${tx.to && tx.to.toLowerCase() === PYUSD_ADDRESS.toLowerCase() ? 
                    '<span class="text-xs dark:text-gold-400 text-gold-600 mt-1 block">PYUSD Contract</span>' : ''}
                </div>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <h4 class="text-sm dark:text-gold-300 text-gold-700 mb-2">Method</h4>
                <div class="code-block">
                  <p class="dark:text-gold-100 text-gray-800">${tx.method || 'Unknown'}${tx.method ? '()' : ''}</p>
                </div>
              </div>
              <div>
                <h4 class="text-sm dark:text-gold-300 text-gold-700 mb-2">Value</h4>
                <div class="code-block">
                  <p class="dark:text-gold-100 text-gray-800">${tx.value || 0} PYUSD</p>
                </div>
              </div>
              <div>
                <h4 class="text-sm dark:text-gold-300 text-gold-700 mb-2">Gas Used</h4>
                <div class="code-block">
                  <p class="dark:text-gold-100 text-gray-800">${tx.gasUsed ? tx.gasUsed.toLocaleString() : 'Unknown'}</p>
                </div>
              </div>
            </div>

            ${tx.flagged && tx.complianceFlags && tx.complianceFlags.length > 0 ? `
              <div class="border-t dark:border-gold-800/30 border-gold-300/50 pt-6 mt-6">
                <h4 class="font-serif text-lg gold-text mb-4">Compliance Flags</h4>
                ${tx.complianceFlags.map(flag => `
                  <div class="dark:bg-dark-900 bg-gold-50 rounded-md border dark:border-gold-800/30 border-gold-300/50 p-4 mb-3">
                    <div class="flex items-start">
                      <div class="flex-shrink-0 mr-3 mt-1">
                        <i class="fas fa-exclamation-triangle ${getSeverityColor(flag.severity)}"></i>
                      </div>
                      <div class="flex-1">
                        <h3 class="text-sm font-medium dark:text-gold-100 text-gray-800">${flag.rule}</h3>
                        <div class="mt-2 text-sm dark:text-gold-200/70 text-gray-600">
                          <p>${typeof flag.details === 'string' ? flag.details : JSON.stringify(flag.details, null, 2)}</p>
                        </div>
                        <div class="mt-3">
                          <span class="status-badge ${getSeverityBgColor(flag.severity)}">
                            ${flag.severity} Risk
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>
                `).join('')}
              </div>
            ` : ''}

            <div class="border-t dark:border-gold-800/30 border-gold-300/50 pt-6 mt-6">
              <h4 class="font-serif text-lg gold-text mb-4">Transaction Trace</h4>
              <div class="code-block overflow-x-auto">
                <pre class="text-xs dark:text-gold-100/80 text-gray-800">${JSON.stringify(trace, null, 2)}</pre>
              </div>
            </div>
          </div>
        `;
      } catch (error) {
        console.error('Error fetching transaction details:', error);
        txDetailsContent.innerHTML = `
          <div class="flex flex-col items-center justify-center py-10 text-center">
            <i class="fas fa-exclamation-circle text-3xl text-red-500 mb-4"></i>
            <p class="text-lg dark:text-gold-100 text-gray-800 mb-2">Failed to load transaction details</p>
            <p class="text-sm dark:text-gold-200/70 text-gray-600">${error.message || 'An unknown error occurred'}</p>
          </div>
        `;
      } finally {
        hideLoading();
      }
    }

    // Helper function to get severity from rule name
    function getSeverityFromRule(rule) {
      // This is a simple example - you may want to implement more sophisticated logic
      if (rule.includes('Blacklisted') || rule.includes('Suspicious')) {
        return 'High';
      } else if (rule.includes('Large')) {
        return 'Medium';
      } else {
        return 'Low';
      }
    }

    // Helper function to get severity color
    function getSeverityColor(severity) {
      switch (severity) {
        case 'High':
          return 'dark:text-red-400 text-red-500';
        case 'Medium':
          return 'dark:text-amber-400 text-amber-500';
        case 'Low':
          return 'dark:text-blue-400 text-blue-500';
        default:
          return 'dark:text-gold-400 text-gold-600';
      }
    }

    // Helper function to get severity background color
    function getSeverityBgColor(severity) {
      switch (severity) {
        case 'High':
          return 'dark:bg-red-500/20 bg-red-100 text-red-500 border dark:border-red-500/30 border-red-200';
        case 'Medium':
          return 'dark:bg-amber-500/20 bg-amber-100 text-amber-500 border dark:border-amber-500/30 border-amber-200';
        case 'Low':
          return 'dark:bg-blue-500/20 bg-blue-100 text-blue-500 border dark:border-blue-500/30 border-blue-200';
        default:
          return 'dark:bg-gold-500/20 bg-gold-100 text-gold-600 border dark:border-gold-500/30 border-gold-200';
      }
    }

    // Set up tab switching
    function setupTabs() {
      const tabs = [
        { tab: tabTransactions, content: contentTransactions, id: 'transactions' },
        { tab: tabAlerts, content: contentAlerts, id: 'alerts' },
        { tab: tabAnalytics, content: contentAnalytics, id: 'analytics' }
      ];
      
      tabs.forEach(({ tab, content, id }) => {
        tab.addEventListener('click', () => {
          // Deactivate all tabs
          tabs.forEach(t => {
            t.tab.classList.remove('tab-active');
            t.tab.classList.add('tab-inactive');
            t.content.classList.add('hidden');
          });
          
          // Activate selected tab
          tab.classList.add('tab-active');
          tab.classList.remove('tab-inactive');
          content.classList.remove('hidden');
          
          // Update active tab in state
          appState.activeTab = id;
        });
      });
    }

    // Set up event listeners
    function setupEventListeners() {
      // Set up tabs
      setupTabs();
      
      // Close modal
      closeModal.addEventListener('click', () => {
        txModal.classList.add('hidden');
      });

      // Close modal when clicking outside
      txModal.addEventListener('click', (e) => {
        if (e.target === txModal) {
          txModal.classList.add('hidden');
        }
      });

      // Filter transactions
      txFilter.addEventListener('change', renderTransactions);
      
      // Filter alerts
      alertFilter.addEventListener('change', renderAlerts);

      // Refresh button
      refreshBtn.addEventListener('click', async () => {
        // Show refreshing state
        refreshBtn.disabled = true;
        refreshBtn.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-2"></i><span class="hidden sm:inline">Refreshing</span>';
        showLoading('Refreshing Data', 'Fetching the latest transactions and alerts...');

        try {
          // Fetch latest status
          const status = await fetchAPI('/status');
          appState.currentBlock = status.currentBlock;
          
          // Fetch latest alerts
          const alerts = await fetchAPI('/alerts');
          appState.alerts = alerts.data || [];
          
          // Update transactions from alerts
          const newTransactions = appState.alerts
            .filter(alert => !appState.transactions.some(tx => tx.hash === alert.txHash))
            .map(alert => ({
              hash: alert.txHash,
              blockNumber: alert.blockNumber,
              flagged: true,
              timestamp: new Date(alert.timestamp),
              complianceFlags: [{
                rule: alert.rule,
                details: alert.details,
                severity: getSeverityFromRule(alert.rule)
              }]
            }));
          
          // Add new transactions to the list
          appState.transactions = [...newTransactions, ...appState.transactions];
          
          // Update UI
          updateStats();
          renderTransactions();
          renderAlerts();
        } catch (error) {
          console.error('Error refreshing data:', error);
          showError('Failed to refresh data: ' + error.message);
        } finally {
          // Reset button
          refreshBtn.disabled = false;
          refreshBtn.innerHTML = '<i class="fas fa-sync-alt mr-2"></i><span class="hidden sm:inline">Refresh</span>';
          hideLoading();
        }
      });
      
      // Add global error handler
      window.addEventListener('error', (event) => {
        console.error('Global error caught:', event.error);
        showError('An error occurred: ' + (event.error?.message || 'Unknown error'));
        event.preventDefault();
        return true;
      });
      
      window.addEventListener('unhandledrejection', (event) => {
        console.error('Unhandled promise rejection:', event.reason);
        showError('An error occurred: ' + (event.reason?.message || 'Unknown error'));
        event.preventDefault();
        return true;
      });
    }

    // Helper function to format date
    function formatDate(date) {
      return new Date(date).toLocaleString();
    }

    // Helper function to format time
    function formatTime(date) {
      return new Date(date).toLocaleTimeString();
    }

    // Initialize the application
    document.addEventListener('DOMContentLoaded', initializeUI);
  </script>
</body>
</html>